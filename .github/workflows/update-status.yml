name: Update SDK Status

on:
  workflow_run:
    workflows: ["Release"]
    types:
      - completed
  schedule:
    - cron: '0 7 * * *'  # Daily at 7 AM UTC (after validation)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-status:
    name: Update SDK Status
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Get latest version from Go proxy
        id: go_version
        run: |
          VERSION=$(curl -s "https://proxy.golang.org/github.com/raphaeltorquat0/iptuapi-go/@latest" | jq -r '.Version' 2>/dev/null || echo "not published")
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Latest Go proxy version: $VERSION"

      - name: Get go.mod module version
        id: pkg_version
        run: |
          # Get latest git tag as version
          VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Git tag version: $VERSION"

      - name: Run validation check
        id: validation
        continue-on-error: true
        run: |
          mkdir -p /tmp/status-check
          cd /tmp/status-check
          go mod init test/status-check
          go get github.com/raphaeltorquat0/iptuapi-go@latest 2>/dev/null

          # Test import
          cat > main.go << 'GOEOF'
          package main

          import (
              "fmt"
              _ "github.com/raphaeltorquat0/iptuapi-go"
          )

          func main() {
              fmt.Println("OK")
          }
          GOEOF

          if go run main.go 2>/dev/null; then
            echo "STATUS=passing" >> $GITHUB_OUTPUT
          else
            echo "STATUS=failing" >> $GITHUB_OUTPUT
          fi

      - name: Get current date
        id: date
        run: echo "DATE=$(date -u +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_OUTPUT

      - name: Update SDK-STATUS.md
        run: |
          cat > SDK-STATUS.md << 'EOF'
          # SDK Status

          > Auto-generated status file. Last updated: ${{ steps.date.outputs.DATE }}

          ## Version Information

          | Metric | Value |
          |--------|-------|
          | **Latest Published** | ${{ steps.go_version.outputs.VERSION }} |
          | **Source Version** | ${{ steps.pkg_version.outputs.VERSION }} |
          | **Registry** | Go Modules (proxy.golang.org) |
          | **Module** | github.com/raphaeltorquat0/iptuapi-go |

          ## Validation Status

          | Check | Status |
          |-------|--------|
          | **Clean Install** | ${{ steps.validation.outputs.STATUS == 'passing' && '✅ Passing' || '❌ Failing' }} |
          | **Go Import** | ${{ steps.validation.outputs.STATUS == 'passing' && '✅ Passing' || '❌ Failing' }} |

          ## Compatibility

          | Go Version | Status |
          |------------|--------|
          | 1.21 | ✅ Supported |
          | 1.22 | ✅ Supported |
          | 1.23 | ✅ Supported |

          ## Links

          - [pkg.go.dev](https://pkg.go.dev/github.com/raphaeltorquat0/iptuapi-go)
          - [API Documentation](https://docs.iptuapi.com.br)
          - [GitHub Repository](https://github.com/raphaeltorquat0/iptuapi-go)

          ---
          *This file is automatically updated by GitHub Actions.*
          EOF

      - name: Commit status update
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add SDK-STATUS.md
          git diff --staged --quiet || git commit -m "chore: update SDK status [skip ci]"
          git push || echo "No changes to push"
